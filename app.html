<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AgroVista Forecast Intelligence</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f7f9f7; color: #333; }
        header { background: linear-gradient(90deg, #2e7d32, #66bb6a); color: white; padding: 20px; text-align: center; }
        header h1 { margin: 0; font-size: 2.3em; }
        main { margin: 40px auto; max-width: 900px; text-align: center; padding: 0 15px; }
        .input-area { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 25px; }
        input#q { flex: 1 1 300px; padding: 12px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; min-width: 200px; }
        button { padding: 12px 20px; font-size: 1em; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; transition: 0.3s; }
        button:hover { background-color: #388e3c; }
        #answer { margin-top: 30px; font-weight: bold; font-size: 1.1em; color: #1b5e20; line-height: 1.6em; }
        #chart { margin-top: 30px; }
        footer { text-align: center; padding: 15px; margin-top: 50px; color: #555; border-top: 1px solid #ddd; }
        .top-actions { display:flex; gap:10px; justify-content:center; margin-bottom: 10px; }
        .small-btn { padding:8px 12px; font-size:0.9em; border-radius:6px; background:#1976d2; color:#fff; border:none; cursor:pointer }
        @media (max-width: 600px) { header h1 { font-size: 1.8em; } button { width: 100%; } input#q { width: 100%; } }
    </style>
</head>
<body>
    <header>
        <h1>AgroVista Forecast Intelligence</h1>
        <p>AI-Powered Agricultural Forecasting for National Food Security</p>
    </header>
    <main>
        <div class="top-actions">
            <button class="small-btn" onclick="openDashboard()">üìä Dashboard</button>
            <button class="small-btn" onclick="upgrade()">‚≠ê Upgrade to PRO</button>
            <button class="small-btn" onclick="logout()">‚èª Logout</button>
        </div>
        <div class="input-area">
            <input id="q" placeholder="Ask about yield, pests, investments, or climate...">
            <button onclick="ask()">Ask</button>
            <button onclick="startListening()">üé§ Speak</button>
            <button onclick="readResponse()">üîä Read Aloud</button>
        </div>
        <div id="answer"></div>
        <div id="chart"></div>
    </main>
    <footer>¬© 2025 FMAFS | AgroVista AI Platform</footer>

<script>
const TOKEN = "{{ token }}";
function getToken(){ return TOKEN || localStorage.getItem('agro_token') || ''; }

async function ask(){
    const q = document.getElementById('q').value;
    if (!q){ document.getElementById('answer').innerText = "Please type a question first."; return; }
    const res = await fetch('/ask', {
        method:"POST",
        headers:{
            'Content-Type':'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({question:q})
    });
    const data = await res.json();
    lastAnswer = data.answer || data.error || '';
    document.getElementById('answer').innerText = lastAnswer;
    if (data.chart){
        document.getElementById('chart').innerHTML = '<img src="data:image/png;base64,' + data.chart + '">';
    }
    if(data.error && data.error.includes('Upgrade')){
        if(confirm(data.error + " Would you like to upgrade now?")){
            upgrade();
        }
    }
}

function startListening(){
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.start();
    recognition.onresult = function(event){
        document.getElementById('q').value = event.results[0][0].transcript;
    };
}

function readResponse(){
    if (!lastAnswer){ alert("No response available to read aloud."); return; }
    if (isReading){ speechSynthesis.cancel(); isReading = false; currentUtterance = null; return; }
    currentUtterance = new SpeechSynthesisUtterance(lastAnswer);
    isReading = true;
    currentUtterance.onend = () => { isReading = false; };
    speechSynthesis.speak(currentUtterance);
}

function openDashboard(){
    const url = "{{ looker_url }}" || '#';
    if(url === '#' || !url){ alert("Looker dashboard link is not set."); return; }
    window.open(url, "_blank");
}

function logout(){
    fetch('/logout').then(()=> window.location.href = '/login');
}

async function upgrade(){
    const res = await fetch('/create_checkout_session', {
        method:'POST',
        headers:{'Content-Type':'application/json', 'Authorization':'Bearer ' + getToken()},
        body: JSON.stringify({price_id: null, amount: 500000})
    });
    const data = await res.json();
    if(data.checkout_url){
        window.location.href = data.checkout_url;
    } else {
        alert(data.error || 'Unable to start payment session.');
    }
}
</script>
</body>
</html>
